<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<script type="text/javascript">
// corechartのパッケージをロード
google.load(
  "visualization",
  "1",
  {
    packages: [ "corechart", 'timeline' ]
  }
);
google.setOnLoadCallback(main);

// メイン
function main() {
  google.script.run.withSuccessHandler(function(data) {
    initVue(data);
    initPlugins();

    // グラフの初期描画
    //graphSQL();
    // グラフの再描画処理
    $('select,input').change(function(){
      console.log($(this).val());
      graphSQL();
    });

  }).setVueDatas();
}

// Vue.jsにわたすオブジェクトの生成
function initVue(datas) {
  var app = new Vue({
    el: '#app',
    data: datas
  });
}

// datepickerとSelect2を初期化
function initPlugins() {
  $('.datepicker').datepicker({
    format: 'yyyy/mm/dd',
    language: 'ja',
  });
  $('.select2').select2();

  // カレンダーボタン
  $('.for-datepicker').on('click', function() {
    $(this).prev().focus();
  });
}

// グラフ発行するSQLを組み立てます
function graphSQL() {
  var sheet_id = '1422079612';
  var user_id = $('#listened_search_user').val();
  var words = $('#listened_search_listen_words').val();

  // Users
  var sql = "SELECT B, H WHERE H IS NOT NULL AND F = "+user_id;

  // Listen words
  for (let i = 0; i < words.length; i++) {
    sql = sql + " AND G LIKE '%25"+words[i]+"%25'";
  } 

  console.log(sql);
  execSQL(sheet_id, sql);
}

// スプレッドシートにSQL発行するやーつ
function execSQL(sheet_id, sql) {
  // Variables
  var ws_id = '15uqxj5YSYxbc-wK7hi-b65GrrT9n-0eJ8hNXfhBsiqE';

  // The URL of the spreadsheet to source data from.
  var url = 'https://docs.google.com/spreadsheets/d/'+ws_id+'/gviz/tq?gid='+sheet_id+'&tq='+sql;
  var query = new google.visualization.Query(url);
  query.send(draw);
}

// SQLの実行結果からグラフを描画するルーチン
function draw(response) {
  if (response.isError()) {
    alert('Error in query');
  }
  //データテーブルに格納する
  var data = response.getDataTable();
  var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

  //グラフオプションの指定
  var title = $('#listened_search_user>option:selected').text()+'さん '+$('#listened_search_listen_words>option:selected').text()+'の推移';
  var options = {
    title: title,
    curveType: 'function',
    legend: {textStyle: {fontSize: 11}},
    dataOpacity: '0.4',
    hAxis: {title: '測定日時'},
    vAxis: {title: $('#listened_search_listen_words>option:selected').text()}
  };

  //グラフの描画
  chart.draw(data, options);
}
</script>